# Finalizer와 Cleaner는 피해라

자바에서는 두가지 객체 소멸자를 제공합니다.

Finalizer는 예측 불가능하고, 위험하며, 대부분 불필요합니다.

Finalizer를 사용하는 경우는 아래 딱 두가지 경우 일 것입니다.

1. close 메서드 호출을 잊은 경우에 대비하는 안전망으로서의 역할
2. 네이티브 피어(native peer)와 연결된 객체를 정리할 때

일단 자바 9에서는 Finalizer가 deprecated 되었고,
Cleaner라는게 새로 생겨서 Finalizer 보다 덜 위험하지만(별도의 쓰레드를 사용하니까), 
여전히 예측 불가능하며, 느리고, 일반적으로 불필요하다.

단점들을 정리해 보면 아래와 같다.

### 언제 실행될지 알 수 없다. 

즉시 실행되리라는 보장이 전혀 없다는 것이다. 어떤 객체에 대한 모든 참조가 사라지고 나서 종료자가 실행되기까지는 긴 시간이 걸릴 수도 있다.
따라서 긴급한(time-critical) 작업을 종료자 안에서 처리하면 안 된다. 예를 들어 종료자 안에서 파일을 닫도록 하면 치명적이다. 

### Finalizer는 인스턴스 반납을 지연 시킬 수도 있다.

Finalizer 쓰레드는 우선 순위가 낮아서 언제 실행될지 모른다. 
따라서, Finalizer 안에 어떤 작업이 있고, 그 작업을 쓰레드가 처리 못해서 대기하고 있다면, 
해당 인스턴스는 GC가 되지 않고 계속 쌓이다가 결국엔 OutOfMomoryException이 발생할 수도 있다.

Clenaer는 별도의 쓰레드로 동작하니까 이 부분에 있어서 조금은 나을 수도 있지만 (해당 쓰레드의 우선순위를 높게 준더거나..), 
여전히 해당 쓰레드는 백그라운드에서 동작하고 언제 처리될지는 알 수 없다.

### Finalizer나 Cleaner로 저장소 상태를 변경하는 일을 하지 말라.

즉시 실행되지 않는 다는건 차치하고 Finalizer나 Cleaner를 아에 실행하지 않을 수도 있다. 
따라서, Finalizer나 Cleaner로 저장소 상태를 변경하는 일을 하지 말라. 
데이터베이스 같은 자원의 락을 그것들로 반환하는 작업을 한다면 전체 분산 시스템이 멈춰 버릴 수도 있다.

### 심각한 성능 문제도 있다.

AutoCloseable 객체를 만들고, try-with-resource로 자원 반납을 하는데 걸리는 시간은 12ns 인데 반해, 
Finalizer를 사용한 경우에 550ns가 걸렸다. 약 50배가 걸렸다. 
Cleaner를 사용한 경우에는 66ns가 걸렸다 약 5배.

### Finalizer 공격이라는 심각한 보안 이슈에도 이용될 수 있다.

https://www.ibm.com/developerworks/library/j-fv/j-fv-pdf.pdf
[finalizer-attack](https://yangbongsoo.gitbook.io/study/finalizer-attack)


어떤 클래스가 있고 그 클래스를 공격하려는 클래스가 해당 클래스를 상속 받는다. 
그리고 그 나쁜 클래스의 인스턴스를 생성하는 도중에 예외가 발생하거나, 직렬화 할 때 예외가 발생하면, 원래는 죽었어야 할 객체의 finalizer가 실행될 수 있다. 
그럼 그 안에서 해당 인스턴스의 레퍼런스를 기록할 수도 있고, GC가 되지 못하게 할 수도 있다. 
또한 그 안에서 인스턴스가 가진 메소드를 호출할 수도 있다.

원래는 생성자에서 예외가 발생해서 존재하질 않았어야 하는 인스턴스인데, Finalizer 때문에 살아 남아 있는 것이다.

Final 클래스는 상속이 안되니까 근본적으로 이런 공격이 막혀 있으며, 다른 클래스는 finalize() 메소드에 final 키워드를 사용해서 상속해서 오버라이딩 하는 것을 만을 수 있다.

### 정리하자면...

Finalizer는 java.lang.Object 클래스에  protected 로 정의된 메소드이며 모든 클래스에서 오버로딩(재정의) 가능한 메소드이고 객체가 gc 에 의해 소멸 되기 직전에 실행되는 특징을 가지고 있습니다.

그렇다면 객체가 종료될때만 꼭 처리되어야 하는 로직은 어떻게 구현해야 할까?
명시적인 종료메서드는 클라이언트 코드는 item9의 Try-Finally 대신 Try-with-Resource를 사용하라를 참고하면 좋겠습니다.
